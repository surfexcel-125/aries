<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workspace — Project</title>
  <style>
    :root{
      --accent: #2e86ff;
      --accent-hover: #1b74ff;
      --link-color: #3b4b54;
      --link-selected: #1b74ff;
      --grid-color: rgba(0,0,0,0.06);
      --header-height: 72px;
    }
    html,body{ height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Arial; color:#0f172a; background:#f8fafc; }
    .topbar {
      height: var(--header-height);
      background: #000;
      color: #fff;
      display: flex;
      align-items: center;
      padding: 0 18px;
      box-shadow: 0 6px 18px rgba(2,6,23,0.25);
      position: fixed; left:0; right:0; top:0; z-index:12000;
    }
    .topbar .left, .topbar .center, .topbar .right { display:flex; align-items:center; }
    .topbar .center { flex:1 1 auto; justify-content:center; }
    .header-title { font-weight:700; font-size:18px; letter-spacing:0.2px; color:#fff; text-align:center; }
    .menu-btn { width:36px; height:36px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; background:transparent; color:#fff; border:none; cursor:pointer; font-size:20px; }
    .btn { background:#fff; color:#111827; border-radius:8px; padding:8px 12px; border:1px solid rgba(0,0,0,0.12); cursor:pointer; font-weight:600; }
    .btn.ghost { background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06); }
    .btn.primary { background:var(--accent); color:#fff; border:none; }
    #canvas { position: absolute; left: 0; right: 0; top: var(--header-height); bottom: 0; overflow: hidden; background: #f3f4f6; }
    #board { position: absolute; left: 0; top: 0; width:2000px; height:1500px; transform-origin:0 0; }
    svg#svg { position: absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:2000; } /* svg above nodes */
    #inspector {
      width: 360px; position: fixed; right: 16px; top: calc(var(--header-height) + 16px);
      bottom: 16px; background: #fff; border-radius: 8px; box-shadow: 0 10px 40px rgba(2,6,23,0.12);
      padding: 18px; box-sizing: border-box; z-index: 14000; transition: transform 180ms ease, opacity 160ms ease;
    }
    #inspector.hidden { transform: translateX(22px) scale(0.99); opacity:0; pointer-events:none; }
    #inspector.visible { transform: none; opacity:1; pointer-events:auto; }
    #floatingTools { position: fixed; left: 18px; bottom: 18px; z-index:13000; background: rgba(255,255,255,0.96); padding:10px; border-radius:12px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); display:flex; gap:8px; align-items:center; }
    #contextMenu { position: absolute; display:none; z-index:16000; background:#fff; border:1px solid rgba(0,0,0,0.08); border-radius:8px; padding:6px; min-width:160px; box-shadow: 0 8px 26px rgba(2,6,23,0.12); }
    #contextMenu button { display:block; width:100%; text-align:left; padding:8px; border:none; background:transparent; cursor:pointer; }
    .node { user-select:none; }
    .node .node-title { font-size:16px; }
    .node .node-body { font-size:13px; margin-top:6px; color:#475569; }
    .controls-panel { position: fixed; right: 18px; bottom: 18px; z-index:13000; background: rgba(255,255,255,0.96); padding:8px; border-radius:12px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); display:flex; gap:6px; align-items:center; }
    #wf-toast { position: fixed; left:50%; transform:translateX(-50%); top: calc(var(--header-height) + 12px); z-index:30000; pointer-events:none; }
    .wf-toast-item { background: rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:8px; margin-top:8px; font-weight:600; }
    #wf-overlay { position: fixed; left:0; top:0; right:0; bottom:0; display:none; z-index:30000; background: rgba(0,0,0,0.65); align-items:center; justify-content:center; color:#fff; padding:18px; box-sizing:border-box; }
    #wf-overlay .card { background: rgba(0,0,0,0.18); border-radius:12px; padding:18px; max-width:860px; }
    @media (max-width:900px) { #inspector { display:none; } .topbar .center { justify-content:flex-start; padding-left:12px; } }
  </style>
</head>
<body>

  <div class="topbar" role="navigation" aria-label="Workspace header">
    <div class="left">
      <button id="menuToggle" class="menu-btn" aria-label="Open menu">☰</button>
    </div>
    <div class="center">
      <div id="headerTitle" class="header-title">Finex</div>
    </div>
    <div class="right header-actions">
      <button id="saveBoard" class="btn" title="Save Board">Save Board</button>
      <button id="exportJson" class="btn" title="Export JSON">Export JSON</button>
      <label style="display:flex;align-items:center;">
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importJsonBtn" class="btn" title="Import JSON">Import JSON</button>
      </label>
      <button id="inspectorToggle" class="btn ghost" title="Toggle inspector">Inspector</button>
      <a href="/projects" id="backToProjects" class="link-btn" style="color:#fff; padding-left:8px;">← Project</a>
    </div>
  </div>

  <div id="canvas" aria-label="Workspace canvas">
    <div id="board" aria-hidden="false">
      <svg id="svg" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
  </div>

  <aside id="inspector" class="hidden" aria-hidden="true">
    <h3>Inspector</h3>
    <div>Selected: <span id="selectedCount">0</span></div>
    <div id="inspectorSingle" style="display:none;">
      <label>Node ID<div id="inspectorId" style="font-weight:600;color:#334155;margin-top:6px"></div></label>
      <label>Type
        <select id="inspectorType">
          <option value="page">Page</option><option value="action">Action</option><option value="decision">Decision</option>
        </select>
      </label>
      <label>Title <input id="inspectorTitle" type="text" /></label>
      <label>Body <textarea id="inspectorBody"></textarea></label>
      <div style="display:flex;gap:8px;">
        <div style="flex:1;"><label>Width <input id="inspectorW" type="number" /></label></div>
        <div style="flex:1;"><label>Height <input id="inspectorH" type="number" /></label></div>
      </div>
      <div class="actions"><button id="inspectorSave" class="btn primary">Save</button><button id="inspectorDelete" class="btn" style="color:#f44336;border:1px solid rgba(244,67,54,0.15)">Delete</button></div>
    </div>
    <div id="inspectorMulti" style="display:none;">Multiple items selected</div>
    <div style="margin-top:14px;">
      <div style="display:flex;gap:8px;align-items:center;">
        <label><input id="showGrid" type="checkbox" checked/> Grid</label>
        <label style="margin-left:8px">Size <input id="gridSize" type="number" value="25" style="width:74px" /></label>
      </div>
      <div style="margin-top:10px;">
        <button id="autosizeBtn" class="btn">Auto-resize board</button>
        <button id="clearAllBtn" class="btn">Clear board</button>
      </div>
      <div id="statusMeta" style="margin-top:12px;color:#64748b;font-size:13px">No changes</div>
    </div>
  </aside>

  <div id="floatingTools"></div>
  <div class="controls-panel">
    <button id="zoomOutCorner" class="btn">-</button>
    <div id="zoomIndicator">100%</div>
    <button id="zoomInCorner" class="btn">+</button>
    <button id="centerBtn" class="btn">Center</button>
    <button id="zoomFitBtn" class="btn">Zoom to fit</button>
  </div>

  <div id="contextMenu" role="menu" aria-hidden="true">
    <button id="contextEdit">Edit</button>
    <button id="contextDelete">Delete</button>
  </div>

  <div id="wf-toast" aria-live="polite"></div>

  <div id="wf-overlay">
    <div class="card" role="dialog" aria-modal="true" style="text-align:left;">
      <h2 style="margin-top:0;">Workspace Tour</h2>
      <p id="wf-overlay-text">Welcome to the workspace. Use anchors to connect, double-click to edit, and press Ctrl+Z to undo.</p>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px;">
        <button id="wf-skip" class="btn">Skip</button>
        <button id="wf-next" class="btn primary">Next</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const url = new URL(window.location.href);
      window.currentProjectId = url.searchParams.get('id') || 'local';
      const inspectorToggle = document.getElementById('inspectorToggle');
      const inspector = document.getElementById('inspector');
      if (inspectorToggle && inspector) {
        inspectorToggle.addEventListener('click', ()=> {
          if (inspector.classList.contains('hidden')) { inspector.classList.remove('hidden'); inspector.classList.add('visible'); inspector.setAttribute('aria-hidden','false'); }
          else { inspector.classList.remove('visible'); inspector.classList.add('hidden'); inspector.setAttribute('aria-hidden','true'); }
        });
      }
      const ft = document.getElementById('floatingTools');
      if (ft) {
        ft.innerHTML = '<button id="toolAddPage" class="btn">Page</button><button id="toolAddAction" class="btn">Action</button><button id="toolAddDecision" class="btn">Decision</button><button id="toolTogglePlace" class="btn">Place Mode</button><button id="toolDeleteNode" class="btn">Delete</button><button id="toolDeleteLink" class="btn">Delete Link</button>';
      }
    })();
  </script>

  <script src="./workspace.js" defer></script>
</body>
</html>
