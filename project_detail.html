<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Workspace ‚Äî Aries Workflow Mapper</title>
<link rel="stylesheet" href="main.css" />
<style>
:root{
  --accent:#0b74ff; --muted:#6b7280; --panel:#ffffffee; --bg:#ffffff;
  --canvas-bg: #f5f5f5;
  --grid-color:rgba(15,23,42,0.08);
  --node-shadow:0 5px 15px rgba(15,23,42,0.1);
  --link-color:#4b5563;
  --link-selected:#ff7a59;
}

/* Basic reset */
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:#0f172a}

/* Header */
.topbar {
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 14px;
  background:#000;
  color:#fff;
  position:sticky;
  top:0;
  z-index:1200;
  box-shadow:0 2px 8px rgba(0,0,0,0.12);
}

/* left area (menu) */
.header-left { display:flex; align-items:center; gap:8px; flex:0 0 auto; z-index:1210; }
.hamburger { 
  background:transparent; border:none; color:#fff; font-size:18px; cursor:pointer; 
  width:36px; height:36px; display:flex; align-items:center; justify-content:center;
  flex:0 0 36px;
}

/* center title absolutely centered so it never collides with left/right */
.header-title {
  font-weight:700;
  font-size:1rem;
  color:#fff;
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:60%;
  text-align:center;
  pointer-events:none; /* so clicks go through to other controls */
}

/* right actions flow */
.header-actions {
  margin-left:auto;
  display:flex;
  gap:8px;
  align-items:center;
  flex:0 0 auto;
  z-index:1210;
  padding-right:12px; /* ensure back link fully inside */
}

/* header buttons */
.topbar .btn, .topbar .tool-btn {
  -webkit-appearance:none; appearance:none;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color:#fff;
  padding:6px 10px;
  font-weight:600;
  cursor:pointer;
}

/* ensure backToProjects sits inside header actions and is visible */
#backToProjects { color:#c8a2ff; text-decoration:none; background:transparent; border:none; padding:6px 8px; }

/* Inspector toggle */
#toggleInspector { background:transparent; border:1px solid rgba(255,255,255,0.08); color:#fff; padding:6px 8px; border-radius:6px; }

/* layout */
.app-shell{ display:flex; height: calc(100vh - 52px); overflow:hidden; }

/* Canvas area */
.canvas-wrap{ flex:1; position:relative; overflow:hidden; background:var(--canvas-bg); }
#canvas{ width:100%; height:100%; position:relative; touch-action:none; user-select:none; }
#board{ position:absolute; left:0; top:0; transform-origin:top left; width:2200px; height:1600px; }

/* Inspector (right panel) */
.inspector {
  width:340px;
  background:#fff;
  border-left:1px solid #eee;
  box-shadow:-6px 0 18px rgba(12,15,20,0.03);
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  z-index:300;
  transition:transform .18s ease, opacity .12s ease;
}
.inspector.hidden { transform: translateX(10px); opacity:0; width:0; padding:0 6px; overflow:hidden; }

/* responsive inspector behavior */
@media (max-width:1000px) {
  .inspector { position:fixed; right:0; top:52px; bottom:0; width:84%; max-width:420px; transform: translateX(100%); opacity:0; }
  .inspector.visible { transform: translateX(0); opacity:1; }
}

/* canvas grid + svg overlay */
#svg{ position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:10 }

/* nodes */
.node{ position:absolute; padding:14px 18px; min-width:160px; min-height:70px; box-shadow:0 5px 15px rgba(15,23,42,0.08); border-radius:12px; background:var(--panel); cursor:grab; transition:box-shadow .08s, border-color .08s; border:2px solid transparent; z-index:15; }
.node.selected{ border-color:var(--accent); box-shadow:0 8px 26px rgba(11,116,255,0.12) }
.node-title{ font-weight:700; margin-bottom:6px; font-size:1.05rem; color:#0f172a }
.node-body{ font-size:0.9rem; color:#374151; word-break:break-word }

/* anchor */
.anchor{ position:absolute; width:12px; height:12px; border-radius:50%; background:var(--accent); border:2px solid #fff; opacity:0; transition:opacity .12s; pointer-events:auto; z-index:30 }
.node:hover .anchor{ opacity:1 }
.output-anchor{ top:50%; right:-6px; transform:translateY(-50%); cursor:crosshair }

/* floating tools bottom-left */
#floatingTools{ position:fixed; bottom:18px; left:18px; display:flex; gap:8px; background:var(--panel); padding:10px; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,0.06); z-index:200 }

/* controls bottom-right */
.controls-panel{ position:fixed; bottom:18px; right:18px; padding:10px; background:var(--panel); border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,0.06); z-index:200; display:flex; gap:10px; align-items:center }

/* context menu */
#contextMenu{ position:absolute; display:none; z-index:400; background:#fff; border:1px solid #ddd; border-radius:6px; box-shadow:0 8px 20px rgba(0,0,0,0.12) }
.context-menu-item{ padding:8px 14px; cursor:pointer }
.context-menu-item:hover{ background:#f7f7f7 }

/* modal for label input */
.modal-backdrop {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.42); z-index:1400;
}
.modal-card { background:#fff; border-radius:10px; padding:18px; width:520px; max-width:92%; box-shadow:0 12px 30px rgba(2,6,23,0.36); }
.modal-card h3 { margin:0 0 8px 0; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

/* small screens */
@media (max-width:700px) {
  .header-title { max-width:52%; }
  .header-actions { gap:6px; }
  #floatingTools { left:8px; bottom:90px; }
  .controls-panel { right:8px; bottom:90px; }
}
</style>
</head>
<body>

<header class="topbar">
  <div class="header-left">
    <button class="hamburger" id="menuIcon" aria-label="Open menu">‚ò∞</button>
  </div>

  <div class="header-title" id="headerTitle">Loading project‚Ä¶</div>

  <div class="header-actions" id="headerActions">
    <button id="saveBoard" class="btn">Save Board</button>
    <button id="exportBtn" class="btn">Export JSON</button>
    <label class="btn" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
      <input id="importFile" type="file" accept="application/json" style="display:none">
      Import JSON
    </label>
    <button id="toggleInspector" title="Toggle Inspector">Inspector</button>
    <a id="backToProjects" href="/projects">‚Üê Project</a>
  </div>
</header>

<div class="app-shell">
  <div class="canvas-wrap">
    <div id="canvas" tabindex="0" aria-label="Workflow Canvas">
      <div id="board" role="application" aria-describedby="headerTitle">
        <svg id="svg" viewBox="0 0 2200 1600" preserveAspectRatio="xMinYMin meet">
          <defs>
            <marker id="arrowhead" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="6" markerHeight="6" orient="auto">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--link-color)" />
            </marker>
            <marker id="arrowhead-selected" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerHeight="6" orient="auto">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--link-selected)" />
            </marker>
          </defs>
        </svg>
      </div>
    </div>

    <div id="floatingTools" role="toolbar" aria-label="Workflow Tools">
      <button id="toolAddPage" class="tool-btn" title="Add Page">üìÑ Page</button>
      <button id="toolAddAction" class="tool-btn" title="Add Action">üõ†Ô∏è Action</button>
      <button id="toolAddDecision" class="tool-btn" title="Add Decision">‚ùì Decision</button>
      <div style="width:1px;height:30px;background:#e5e7eb;margin-inline:6px"></div>
      <button id="toolDeleteNode" class="tool-btn" disabled>üóëÔ∏è Delete</button>
      <button id="toolDeleteLink" class="tool-btn" disabled>‚úÇÔ∏è Delete Link</button>
    </div>

    <div class="controls-panel">
      <div>
        <button id="zoomOutCorner" class="icon-btn">-</button>
        <span id="zoomIndicator" style="width:60px; display:inline-block; text-align:center; font-weight:600">100%</span>
        <button id="zoomInCorner" class="icon-btn">+</button>
      </div>
      <div>
        <label><input id="showGrid" type="checkbox" checked> Grid</label>
        <label style="margin-left:8px">Size <input id="gridSize" type="number" value="25" min="5" max="200" style="width:70px"></label>
        <button id="centerBtn" style="margin-left:8px">Center</button>
        <button id="zoomFitBtn" style="margin-left:8px">Zoom to fit</button>
      </div>
    </div>

    <div id="contextMenu">
      <div class="context-menu-item" id="contextEdit">Edit Node</div>
      <div class="context-menu-item" id="contextDelete">Delete Node</div>
    </div>
  </div>

  <aside class="inspector hidden" id="inspector" aria-label="Node inspector">
    <h4>Inspector</h4>
    <div class="meta">Selected: <span id="selectedCount">0</span></div>

    <div id="inspectorMulti" style="display:none">
      <div class="field"><label>Group action</label>
        <button id="alignLeft">Align Left</button>
        <button id="alignTop">Align Top</button>
      </div>
    </div>

    <div id="inspectorSingle" style="display:none">
      <div class="field"><label>Node ID</label><div class="meta" id="inspectorId"></div></div>
      <div class="field"><label>Type</label>
        <select id="inspectorType">
          <option value="page">Page</option><option value="action">Action</option><option value="decision">Decision</option>
        </select>
      </div>
      <div class="field"><label>Title</label><input id="inspectorTitle" /></div>
      <div class="field"><label>Body</label><textarea id="inspectorBody" rows="5"></textarea></div>
      <div class="field" style="display:flex;gap:8px"><div style="flex:1"><label>Width</label><input id="inspectorW" type="number"></div><div style="flex:1"><label>Height</label><input id="inspectorH" type="number"></div></div>
      <div style="display:flex; gap:8px; margin-top:6px">
        <button id="inspectorSave" class="btn">Save</button>
        <button id="inspectorDelete" class="btn">Delete</button>
      </div>
    </div>

    <hr/>
    <div class="field"><label>Board</label>
      <button id="autosizeBtn">Auto-resize board</button>
      <button id="clearAllBtn">Clear board</button>
    </div>
    <div class="field">
      <label>Import / Export</label>
      <div style="display:flex; gap:8px">
        <button id="exportJson">Download JSON</button>
        <button id="importJsonBtn">Load JSON</button>
      </div>
    </div>

    <div class="field">
      <label>Status</label>
      <div class="meta" id="statusMeta">No changes</div>
    </div>
  </aside>
</div>

<!-- Modal for entering transition label (replaces prompt) -->
<div id="labelModalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="labelModalTitle">
    <h3 id="labelModalTitle">Enter transition label</h3>
    <p class="meta">Example: Next, Success</p>
    <input id="labelModalInput" type="text" style="width:100%; padding:8px; margin-top:8px; border-radius:6px; border:1px solid #ddd" value="Next" />
    <div class="modal-actions">
      <button id="labelModalCancel" class="btn">Cancel</button>
      <button id="labelModalOk" class="btn" style="background:var(--accent); color:#fff;">OK</button>
    </div>
  </div>
</div>

<script type="module" src="firebase-config.js"></script>
<script type="module" src="app.js"></script>

<script type="module">
  function getProjectIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
  }
  window.currentProjectId = getProjectIdFromUrl();
  if (!window.currentProjectId) {
    alert("No project ID found ‚Äî returning to projects.");
    window.location.href = "projects.html";
  } else {
    document.getElementById('headerTitle').textContent = `Project ${window.currentProjectId.substring(0,6)}`;
  }

  // Inspector toggle + import wiring
  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('toggleInspector');
    const inspector = document.getElementById('inspector');
    const importFile = document.getElementById('importFile');

    function setInspectorVisible(v) {
      if (window.matchMedia && window.matchMedia('(max-width:1000px)').matches) {
        inspector.classList.toggle('visible', v);
        inspector.classList.toggle('hidden', !v);
      } else {
        inspector.classList.toggle('hidden', !v);
        inspector.classList.remove('visible');
      }
    }
    setInspectorVisible(false);

    toggleBtn.addEventListener('click', () => {
      const isHidden = inspector.classList.contains('hidden') && !inspector.classList.contains('visible');
      setInspectorVisible(isHidden);
    });

    importFile.addEventListener('change', (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        let payload = null;
        try { payload = JSON.parse(e.target.result); } catch(err) { alert('Invalid JSON file'); return; }
        document.dispatchEvent(new CustomEvent('workspace:importJson', { detail: payload }));
      };
      reader.readAsText(file);
      ev.target.value = '';
    });
  });

  // Label modal helper exposed as Promise:
  window.requestTransitionLabel = function(defaultValue = "Next") {
    return new Promise((resolve) => {
      const bd = document.getElementById('labelModalBackdrop');
      const input = document.getElementById('labelModalInput');
      const ok = document.getElementById('labelModalOk');
      const cancel = document.getElementById('labelModalCancel');
      bd.style.display = 'flex';
      bd.setAttribute('aria-hidden','false');
      input.value = defaultValue || '';
      input.focus();
      function cleanup() {
        bd.style.display = 'none';
        bd.setAttribute('aria-hidden','true');
        ok.removeEventListener('click', onOk);
        cancel.removeEventListener('click', onCancel);
        bd.removeEventListener('keydown', onKey);
      }
      function onOk() { const v = input.value.trim(); cleanup(); resolve(v === '' ? null : v); }
      function onCancel() { cleanup(); resolve(null); }
      function onKey(e) { if (e.key === 'Enter') onOk(); if (e.key === 'Escape') onCancel(); }
      ok.addEventListener('click', onOk);
      cancel.addEventListener('click', onCancel);
      bd.addEventListener('keydown', onKey);
    });
  };
</script>

<script src="workspace.js" defer></script>
</body>
</html>
