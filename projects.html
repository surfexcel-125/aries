<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projects — Aries</title>

  <style> html { overflow-y: scroll; } </style>
  <link rel="stylesheet" href="main.css">

  <style>
    .page-wrapper { padding-top:84px; }
    .projects-container { max-width: 900px; margin: 18px auto; padding: 0 18px 48px; }

    .proj-card {
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:14px; background:#fff; border-radius:10px; border:1px solid rgba(0,0,0,0.08);
      box-shadow:0 2px 0 rgba(0,0,0,0.04); margin-bottom:12px; min-height:86px;
    }
    .proj-left { display:flex; align-items:center; gap:12px; }
    .proj-icon {
      width:56px; height:56px; border-radius:8px; display:flex; align-items:center; justify-content:center;
      background:#fff; border:1px solid rgba(0,0,0,0.06); box-shadow:0 1px 0 rgba(0,0,0,0.04); flex-shrink:0;
    }
    .proj-icon img { width:46px; height:46px; object-fit:contain; display:block; }

    .proj-meta { display:flex; flex-direction:column; gap:4px; }
    .proj-title {
      font-weight:800; font-size:16px; color:#0b1220;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .proj-sub { font-size:13px; color:#6b7280; }

    .proj-actions { display:flex; gap:10px; align-items:center; justify-content:flex-end; }

    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 14px; border-radius:8px;
      border:1px solid rgba(0,0,0,0.08);
      font-weight:700; font-size:14px;
      cursor:pointer; text-decoration:none;
      color:#111; background:#fff;
    }
    .btn-open {
      background:#1f2a37; color:#fff;
      border-color:rgba(0,0,0,0.12);
      box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset;
    }
    .btn-edit { background:#fff; color:#111; }
    .btn-delete { background:#fff; color:#111; border:2px solid rgba(0,0,0,0.08); }

    @media (max-width:640px) {
      .proj-card { flex-direction:column; align-items:flex-start; gap:12px; padding:12px; }
      .proj-actions { width:100%; justify-content:flex-start; gap:8px; }
    }
  </style>
</head>
<body>

<header class="aries-topbar">
  <button id="aries-hamburger" class="aries-hamburger" aria-label="Open sidebar">☰</button>
  <span class="aries-title">PROJECT MANAGER</span>
  <a href="home.html" class="aries-brand"><img src="goat.png" alt="Aries Logo" class="aries-logo"></a>
</header>

<div id="aries-overlay" class="hidden" aria-hidden="true"></div>
<aside id="aries-sidebar" class="aries-sidebar hidden" role="complementary" aria-label="Project list" aria-hidden="true">
  <nav class="aries-sidebar-nav aries-sidebar-content" role="navigation" aria-label="Projects"></nav>
</aside>

<main class="page-wrapper">
  <div class="projects-container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <h2 style="margin:0;font-family:'Montserrat',Arial, sans-serif">PROJECTS</h2>
      <button id="openNewProjectModal" class="btn" style="border-radius:8px;padding:8px 12px;">Add Project +</button>
    </div>

    <div id="projectsList" aria-live="polite"></div>
    <div id="initialLoader" class="loader-panel" style="padding:24px;text-align:center;color:#666; display:none;">
      <div class="loader-spinner" style="display:inline-block"></div>
      <p style="margin-top:8px">Connecting to Aries Cloud...</p>
    </div>
  </div>
</main>

<div id="newProjectModal" class="hidden" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:900">
  <div style="background:#fff;padding:18px;border-radius:8px;min-width:320px">
    <div style="font-weight:800;margin-bottom:8px">Create New Project</div>
    <input id="projectNameInput" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" placeholder="Project name">
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="cancelProjectBtn" class="btn">Cancel</button>
      <button id="confirmProjectBtn" class="btn btn-open">Create</button>
    </div>
  </div>
</div>

<script type="module">
  import { auth } from './firebase-config.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import './app.js';

  const listEl = document.getElementById('projectsList');
  const loader = document.getElementById('initialLoader');
  const modal = document.getElementById('newProjectModal');
  const input = document.getElementById('projectNameInput');
  const confirmBtn = document.getElementById('confirmProjectBtn');

  function makeCard(project) {
    const card = document.createElement('div');
    card.className = 'proj-card';

    const left = document.createElement('div');
    left.className = 'proj-left';

    const icon = document.createElement('div');
    icon.className = 'proj-icon';

    const img = document.createElement('img');
    img.src = project?.icon || 'goat.png';
    img.alt = project?.name ? `${project.name} icon` : 'Aries';
    icon.appendChild(img);

    const meta = document.createElement('div');
    meta.className = 'proj-meta';

    const title = document.createElement('div');
    title.className = 'proj-title';
    title.textContent = `${project?.name || 'Untitled'} — ${project?.short || 'Product Plan'}`;

    const sub = document.createElement('div');
    sub.className = 'proj-sub';
    sub.textContent = project?.subtitle || 'Product & roadmap board';

    meta.appendChild(title);
    meta.appendChild(sub);
    left.appendChild(icon);
    left.appendChild(meta);

    const actions = document.createElement('div');
    actions.className = 'proj-actions';

    const openBtn = document.createElement('a');
    openBtn.className = 'btn btn-open';
    openBtn.href = `project_detail.html?id=${project?.id || ''}`;
    openBtn.textContent = 'Open';

    const editBtn = document.createElement('a');
    editBtn.className = 'btn btn-edit';
    editBtn.href = `workspace.html?id=${project?.id || ''}`;
    editBtn.textContent = 'Edit';

    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-delete';
    delBtn.type = 'button';
    delBtn.textContent = 'Delete';

    delBtn.addEventListener('click', async () => {
      if (!project?.id) { alert('Nothing to delete'); return; }
      const ok = confirm(`Delete project “${project.name}”? This cannot be undone.`);
      if (!ok) return;

      if (window.AriesDB && typeof window.AriesDB.deleteProject === 'function') {
        try {
          const success = await window.AriesDB.deleteProject(project.id);
          if (success) {
            card.remove();
          } else {
            alert('Delete failed. Check console for details or your Firestore rules.');
          }
        } catch (err) {
          console.error(err);
          alert('Delete failed. Check console for details.');
        }
      } else {
        alert('Delete is not enabled in this build. To enable, add deleteProject(id) to app.js AriesDB facade.');
      }
    });

    actions.appendChild(openBtn);
    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    card.appendChild(left);
    card.appendChild(actions);
    return card;
  }

  async function loadProjects() {
    loader.style.display = 'block';
    listEl.innerHTML = '';
    try {
      const projects = await window.AriesDB.getProjects();
      loader.style.display = 'none';

      if (!projects || projects.length === 0) {
        const example = {
          name: 'Alpha',
          short: 'Product Plan',
          subtitle: 'Product & roadmap board',
          icon: 'goat.png'
        };
        listEl.appendChild(makeCard(example));
        return;
      }

      projects.forEach(p => {
        const ui = {
          id: p.id,
          name: p.name || 'Untitled',
          short: p.type || 'Product Plan',
          subtitle: p.description || 'Product & roadmap board',
          icon: p.icon || 'goat.png'
        };
        listEl.appendChild(makeCard(ui));
      });

    } catch (err) {
      loader.style.display = 'none';
      listEl.innerHTML = '<div style="padding:24px;color:#c33">Failed to load projects</div>';
      console.error(err);
    }
  }

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }
    loadProjects();
  });

  document.getElementById('openNewProjectModal').onclick = () => modal.classList.remove('hidden');
  document.getElementById('cancelProjectBtn').onclick = () => modal.classList.add('hidden');

  confirmBtn.addEventListener('click', async () => {
    const name = input.value.trim();
    if (!name) return;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Creating...';
    const id = await window.AriesDB.createProject(name);
    if (id) {
      location.href = `project_detail.html?id=${id}`;
    } else {
      alert('Failed to create');
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Create';
    }
  });
</script>
</body>
</html>
