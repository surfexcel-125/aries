<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projects — Aries</title>
  <link rel="stylesheet" href="main.css">
  <style>
    /* Status Pill Styles (copied from previous projects.html styles for completeness) */
    .status-pill {
        background: #f3f3f3; 
        padding: 6px 14px; 
        border-radius: 99px;
        border: 2px solid #4a6468; 
        font-weight: 700; 
        cursor: pointer;
        text-decoration: none; 
        color: black; 
        display: inline-block;
        font-size: 12px;
    }

    /* New: Explicit initial loading screen style */
    #initialLoader {
        text-align: center;
        padding: 50px;
        font-size: 1.2rem;
        color: #666;
    }
  </style>
</head>
<body>

  <header class="topbar">
    <button class="hamburger">☰</button>
    <div class="brand">PROJECT MANAGER</div>
    <img src="images/goat.png" class="logo">
  </header>

  <div class="page-wrapper">
    <div class="container">
      <div class="projects-bar">
        <h2 style="margin:0; font-family:'Sitka Small'; letter-spacing:1px;">MY PROJECTS</h2>
        <button id="openNewProjectModal" class="new-project-btn">+ NEW PROJECT</button>
      </div>

      <div id="projectsList" class="projects-list" style="display:none;">
        </div>
      
      <div id="initialLoader">
        <div class="loader-spinner"></div>
        <p>Connecting to Aries Cloud... Please wait.</p>
      </div>

      <div id="noProjects" style="display:none; padding:40px; text-align:center; color:#666;">
        No projects found. Start by creating one!
      </div>
    </div>
  </div>

  <div id="newProjectModal" class="modal-backdrop">
      <div class="modal-box">
          <div class="modal-title">Create New Project</div>
          <input type="text" id="projectNameInput" class="modal-input" placeholder="e.g. Website Redesign">
          <div class="modal-actions">
              <button id="cancelProjectBtn" class="btn-ghost">Cancel</button>
              <button id="confirmProjectBtn" class="btn-primary">Create</button>
          </div>
      </div>
  </div>

  <script type="module">
    import './app.js'; 

    const listEl = document.getElementById('projectsList');
    const initialLoader = document.getElementById('initialLoader');
    const modal = document.getElementById('newProjectModal');
    const input = document.getElementById('projectNameInput');
    const confirmBtn = document.getElementById('confirmProjectBtn');
    
    // Helper to render a single project row
    function createProjectRow(p) {
        const row = document.createElement('div');
        row.className = 'project-row';
        row.innerHTML = `
            <div class="project-inner">
                <a href="project_detail.html?id=${p.id}" class="project-pill project-name-pill">
                    <img src="images/goat.png" style="width:30px; border-radius:4px;">
                    ${p.name}
                </a>
                <div>
                    STATUS: 
                    <button class="status-pill" data-project-id="${p.id}">${p.status || 'Active'}</button>
                </div>
            </div>
        `;
        return row;
    }

    // 1. Load Projects
    async function loadProjects() {
        try {
            // This is the line that will pause until app.js resolves the Firebase auth
            const projects = await window.AriesDB.getProjects();
            
            initialLoader.style.display = 'none'; // Hide the loading message
            listEl.style.display = 'flex'; // Show the project list
            listEl.innerHTML = ''; // Clear any loading content
            
            if(projects.length === 0) {
                document.getElementById('noProjects').style.display = 'block';
                return;
            }
            document.getElementById('noProjects').style.display = 'none';

            projects.forEach(p => listEl.appendChild(createProjectRow(p)));
            
        } catch (error) {
            console.error("Failed to load projects:", error);
            initialLoader.innerHTML = '<p style="color:red;">Error connecting to Aries Cloud. Check your console (F12) for network errors.</p>';
            listEl.style.display = 'none';
        }
    }

    // Start loading immediately after DOM is ready
    document.addEventListener('DOMContentLoaded', loadProjects);


    // Modal Logic (New Project Creation)
    document.getElementById('openNewProjectModal').onclick = () => {
        modal.classList.add('active');
        input.focus();
    };
    
    document.getElementById('cancelProjectBtn').onclick = () => modal.classList.remove('active');
    modal.addEventListener('click', (e) => { 
        if (e.target === modal) modal.classList.remove('active');
    });

    confirmBtn.onclick = async () => {
        const name = input.value.trim();
        if(!name) return;
        
        confirmBtn.textContent = "Creating...";
        confirmBtn.disabled = true;
        
        const newId = await window.AriesDB.createProject(name);
        
        if (newId) {
            window.location.href = `project_detail.html?id=${newId}`;
        } else {
            alert("Error creating project. Please try again.");
            confirmBtn.textContent = "Create";
            confirmBtn.disabled = false;
        }
    };
  </script>
</body>
</html>
